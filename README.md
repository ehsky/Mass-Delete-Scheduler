# Simple Mass Delete Scheduler for Administrators

## Background

Salesforce does not have a standard framework for deleting records on a regular basis.

Example use cases:

- Delete stail leads created over two years ago that have not been viewed by a user in two years <br/>
  ` SELECT Id FROM Lead WHERE CreatedDate < LAST_N_DAYS:730 AND LastViewedDate < LAST_N_DAYS:730 ORDER BY CreatedDate DESC`
- Delete contacts or accounts that have requested to be deleted. <br/>
  `SELECT Id FROM Contact WHERE PendingDeletion__c = TRUE`
- Delete logs from your logger objects <br/>
  ` SELECT ID FROM Logs__c WHERE CreatedDate < LAST_N_DAYS:30`

## Ad-hoc deletion

You can delete records pr. need using Anoynomous Apex, using the script below. The first parameter you pass in is the query of the records that you want to delete. <br/>
The second parameter you pass in control if we are additionally going to delete the record from the recycle bin.

`Database.executeBatch(new MassDeleteBatchable('SELECT Id FROM Contact WHERE PendingDeletion__c = TRUE LIMIT 50', 'true'));`

# How to set up new scheduled delete job

1.  Open Salesforce **Setup**
2.  Go to **Custom Metadata Types**
3.  On the Metadata Type **Query**, click **Manage Records**
4.  Click **New**
5.  Fill in the fields to create your new Query-record
    1.  Label: Simple Description of your query record. Example. 'Delete Old Leads'
    2.  Query Name: Is Automatically filled
    3.  Description: More detailed description of the query. Please describe what is being deleted and why. If possible, link to relevant JIRA-ticket.
    4.  Active: Should be true if you want the deletion to run each night.
    5.  Object: Select the object of the records to delete
    6.  Operation Type: Select **Delete**
    7.  Hard Delete: Select this if you want the records to be **hard deleted**. If not selected, the records will remain in the Recycle Bin for 15 days.
    8.  Condition: This field contains the condition that determines what records should be deleted. This will be used in a SOQL-query following the WHERE-clause. For example, the value could be `CreatedDate < LAST_N_DAYS:365`.
    9.  Protected Component: Leave this value unchecked.

## Query Custom Metadata Type

For a simple administration of what records are to be deleted, a new Custom Metadata Type Query has been created. This object can be used to hold specific SOQL queries. If the Operation Type of the Query is 'Delete', this query decides that these records will be deleted.
With this setup, an adminitrator can easily disable active queries to avoid them running on the next scheduled delete-run. It's also very easy to add or remove queries. The custom metadata type can also be further extended if relevant.

### Query Fields

| Field Type     | Field Name     | API Name            | Data Type             | Example            | Description                                                                                                                                           |
| -------------- | -------------- | ------------------- | --------------------- | ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| Standard Field | Label          | MasterLabel         | Text(40)              | Delete Leads Query | Descriptive Label of the query                                                                                                                        |
| Standard Field | Query Name     | DeveloperName       | Text(40)              | Delete_Leads_Query | API name of the query, autogenerated from label                                                                                                       |
| Custom Field   | Active         | IsActive\_\_c       | Checkbox              | true               | Indicates if the query is "active". In classes querying query-records, make sure to only use the active-queries                                       |
| Custom Field   | Condition      | Condition\_\_c      | Text Area (255)       | LastName = 'Test'  | The condition contains the WHERE-clause of the query. Used to define the condition of the query to be updated/deleted.                                |
| Custom Field   | Description    | Description\_\_c    | Text Area (255)       |                    | Descriptive text of the query record. Should explain to other admins what the query is used for.                                                      |
| Custom Field   | Hard Delete    | Is_Hard_Delete\_\_c | Checkbox              | true               | Used for Delete-operations. If true, the records will be permanently deleted and can't be recovered from the Recycle Bin.                             |
| Custom Field   | Object         | Object\_\_c         | Metadata Relationship | Lead               | Salesforce SObject Type                                                                                                                               |
| Custom Field   | Operation Type | Operation_Type\_\_c | Picklist              | Delete             | Operation type of the query. Values are currently Delete and Update, can be extended if we see the need for other query records for other operations. |

# Future potential improvments

- Add support for tolling API to be able to delete old flow versions.
- Add update action for boolean values. This can be used to auto disable inactive users.
- Support for deleting related records
